See comments in code for explanation
